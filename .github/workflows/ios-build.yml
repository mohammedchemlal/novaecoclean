name: iOS CI - build IPA (requires secrets)

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          cd mobile
          npm ci

      - name: Install expo cli
        run: |
          cd mobile
          npm install -g expo-cli

      - name: Prebuild iOS (generate native project)
        run: |
          cd mobile
          npx expo prebuild --platform ios --no-interactive

      - name: Decode certificate and provisioning profile
        env:
          APPLE_CERT_P12: ${{ secrets.APPLE_CERT_P12_BASE64 }}
          APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERT_P12_PASSWORD }}
          PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          set -e
          mkdir -p mobile/ios/certs
          if [ -n "$APPLE_CERT_P12" ]; then echo "$APPLE_CERT_P12" | base64 --decode > mobile/ios/certs/cert.p12; fi
          if [ -n "$PROVISIONING_PROFILE" ]; then echo "$PROVISIONING_PROFILE" | base64 --decode > mobile/ios/certs/profile.mobileprovision; fi

      - name: Import certificate to keychain
        if: ${{ secrets.APPLE_CERT_P12_BASE64 }}
        env:
          APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERT_P12_PASSWORD }}
        run: |
          security create-keychain -p actions ios-build.keychain
          security default-keychain -s ios-build.keychain
          security unlock-keychain -p actions ios-build.keychain
          security import mobile/ios/certs/cert.p12 -k ios-build.keychain -P "$APPLE_CERT_PASSWORD" -T /usr/bin/codesign

      - name: Copy provisioning profile
        if: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp mobile/ios/certs/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Build iOS archive and export IPA
        env:
          EXPORT_METHOD: ad-hoc
        run: |
          cd mobile/ios
          # Update bundle id and scheme if needed
          xcodebuild -workspace Runner.xcworkspace -scheme Runner -configuration Release -derivedDataPath build archive -archivePath build/Runner.xcarchive || true
          xcodebuild -exportArchive -archivePath build/Runner.xcarchive -exportPath build/Runner -exportOptionsPlist exportOptions.plist || true

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-ipa
          path: mobile/ios/build/Runner.ipa
